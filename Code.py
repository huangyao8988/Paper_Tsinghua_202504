# -*- coding: utf-8 -*-
import agentscope
from agentscope.manager import ModelManager
from agentscope.agents import ReActAgent
from agentscope.pipelines import SequentialPipeline
from agentscope.rag.knowledge_bank import KnowledgeBank
from agentscope.service import (
    read_text_file,
    write_text_file,
    cos_sim,
    create_file,
    ServiceToolkit,
    ServiceResponse,
    ServiceExecStatus,
)
import json
import os
from agentscope.msghub import msghub
from agentscope.message import Msg

# 读取jsonl文件并生成prompt列表
def read_jsonl_file(file_path):
    """
    读取jsonl文件并生成prompt内容列表。

    :param file_path: jsonl文件的路径
    :return: 包含prompt内容的列表和新的jsonl文件路径
    """
    prompt_list = []
    new_jsonl_lines = []  # 用于存储新jsonl文件的每一行

    # 获取新文件名
    file_name, file_ext = os.path.splitext(file_path)
    new_file_path = "Report_qwen-max_05.jsonl"

    with open(file_path, 'r', encoding='utf-8') as file:
        for line in file:
            # 解析每一行的JSON数据
            json_data = json.loads(line.strip())
            
            # 提取所需的键值
            owner = json_data.get('Owner', '')
            domain_of_owner = json_data.get('Domain_of_the_Owner', '')
            owner_responsibilities = json_data.get('Owner_Responsibilities', '')
            project_background = json_data.get('Project_Background', '')
            project_requirements = json_data.get('Project_Requirements', '')
            requirement_contents = json_data.get('Requirement_Contents', '')
            
            # 生成prompt内容
            prompt = (f"项目需求为：请根据项目需求编写初步可行性研究报告，语言为中文。"
                      f"业主领域为{domain_of_owner}。"
                      f"业主为{owner}。"
                      f"业主职责为{owner_responsibilities}。"
                      f"项目需求为{project_requirements}，"
                      f"需求内容为{requirement_contents}。"
                      f"项目背景为{project_background}。")
            
            # 将生成的prompt添加到列表中
            prompt_list.append((prompt, domain_of_owner))  # 将domain_of_owner与prompt一起存储

            # 根据domain_of_owner生成新jsonl文件的每一行
            if domain_of_owner == "政府侧":
                new_json_data = {f"chapter{str(i).zfill(2)}": "" for i in range(1, 11)}  # chapter01到chapter10
            elif domain_of_owner == "企业侧":
                new_json_data = {f"chapter{str(i).zfill(2)}": "" for i in range(1, 10)}  # chapter01到chapter09
            else:
                new_json_data = {}  # 默认情况

            new_jsonl_lines.append(json.dumps(new_json_data, ensure_ascii=False))

    # 将新jsonl文件写入磁盘
    with open(new_file_path, 'w', encoding='utf-8') as new_file:
        new_file.write('\n'.join(new_jsonl_lines))

    return prompt_list, new_file_path

# 主函数
def main():
    # 读取jsonl文件并生成prompt列表
    jsonl_file_path = 'Data_初可研调研_V1.0.jsonl'  # 替换为你的jsonl文件路径
    prompts_with_domain, new_file_path = read_jsonl_file(jsonl_file_path)

    # 初始化agentscope
    with open("configs/model_config.json", "r", encoding="utf-8") as f:
        model_configs = json.load(f)

    agentscope.init(
        model_configs=model_configs,
        project="Assistant_FSR_V1.0",
        save_api_invoke=True,
        logger_level="DEBUG",
    )

    # 加载模型配置
    ModelManager.get_instance().load_model_configs(
        [
            {
                "api_key": "sk-7adc868b5d4f4136877d96b6977c6956",
                "config_name": "qwen_config",
                "messages_key": "input",
                "model_name": "qwen-max",
                "model_type": "dashscope_chat",
            }
        ]
    )

    '''
    # 初始化知识库
    knowledge_bank = KnowledgeBank(configs="configs/knowledge_config.json")

    # 自定义工具函数
    def retrieve_from_knowledge(query: str, knowledge_id: str = "keyan_02") -> ServiceResponse:
        """
        Retrieve the most similar content from the knowledge based on the query.
        Args:
            query (`str`):
                The query to search for in the knowledge.
            knowledge_id (`str`):
                The ID of the knowledge to search within. Default is "keyan_02".
            similarity_top_k (`int`):
                The number of most similar data to return.
        """
        try:
            # Get the knowledge object from the knowledge bank
            knowledge = knowledge_bank.get_knowledge(knowledge_id=knowledge_id)
            
            # Retrieve the most similar content from the knowledge
            retrieved_content = knowledge.retrieve(query, similarity_top_k=1, to_list_strs=True)
            
            # Convert the retrieved content to a string format
            output = "\n".join(retrieved_content)
            status = ServiceExecStatus.SUCCESS
        except Exception as e:
            # If an exception occurs, capture the exception information
            output = str(e)
            status = ServiceExecStatus.ERROR

        # Wrap the output and status into a ServiceResponse object
        return ServiceResponse(status, output)
    '''  


    def update_jsonl_file(file_path: str, report_index: int, key: str, new_value: str) -> ServiceResponse:
        """
        更新JSONL文件中的特定键值对。

        Args:
            file_path (`str`):
                The path to the JSONL file.
            report_index (`int`):
                The index of the report (line number in the JSONL file).
            key (`str`):
                The key in the JSON object to update.
            new_value (`str`):
                The new value to set for the specified key.

        Returns:
            `ServiceResponse`: A response indicating success or failure.
        """
        try:
            # Read the JSONL file line by line
            with open(file_path, "r", encoding="utf-8") as file:
                lines = file.readlines()

            # Check if the report index is valid
            if report_index < 0 or report_index >= len(lines):
                return ServiceResponse(
                    status=ServiceExecStatus.ERROR,
                    content=f"IndexError: Report index {report_index} is out of range.",
                )

            # Parse the target JSON object
            report = json.loads(lines[report_index])

            # Update the specified key
            if key not in report:
                return ServiceResponse(
                    status=ServiceExecStatus.ERROR,
                    content=f"KeyError: Key '{key}' does not exist in the report.",
                )
            report[key] = new_value

            # Write the updated JSON object back to the file
            lines[report_index] = json.dumps(report, ensure_ascii=False) + "\n"
            with open(file_path, "w", encoding="utf-8") as file:
                file.writelines(lines)

            return ServiceResponse(
                status=ServiceExecStatus.SUCCESS,
                content="Successfully updated the JSONL file.",
            )

        except Exception as e:
            error_message = f"{e.__class__.__name__}: {e}"
            return ServiceResponse(
                status=ServiceExecStatus.ERROR,
                content=error_message,
            )


    # 循环处理每个prompt
    for i, (prompt, domain_of_owner) in enumerate(prompts_with_domain):

        # 创建所有代理
        agent_counselor_service_toolkit = ServiceToolkit()
        agent_counselor_service_toolkit.add(update_jsonl_file)

        # 政府侧代理
        agent_counselor_gov_01 = ReActAgent(
            name="咨询单位（政府侧）01",
            sys_prompt=(
                f"目标：咨询单位（政府侧）01需根据项目需求和可研大纲的二章（第二章项目建设背景和必要性），编写初步可行性研究报告的二章。编写完成后，将编写的内容存入{new_file_path}文件中report_index为{i}的对应键chapter02中。"
                f"控制约束内容：咨询单位（政府侧）01在编写初步可行性研究报告的二章时需严格根据项目需求和可研大纲的二章（第二章项目建设背景和必要性）来编写，不可以瞎编或照抄可研大纲的内容。编写的内容需进行说明和公开通知，编写的内容需用markdown格式表示，分段使用段落分隔符“\n\n”。"
                f"支持使能内容：项目需求来自Host发布的共享信息。可研大纲的二章内容如下：二、项目建设背景和必要性（一）项目建设背景简述项目立项背景，项目用地预审和规划选址等行政审批手续办理和其他前期工作进展。（二）规划政策符合性阐述项目与经济社会发展规划、区域规划、专项规划、国土空间规划等重大规划的衔接性，与扩大内需、共同富裕、乡村振兴、科技创新、节能减排、碳达峰碳中和、国家安全和应急管理等重大政策目标的符合性。（三）项目建设必要性从重大战略和规划、产业政策、经济社会发展、项目单位履职尽责等层面，综合论证项目建设的必要性和建设时机的适当性。"
            ),
            model_config_name="qwen_config",
            max_iters=15,
            verbose="True",
            service_toolkit=agent_counselor_service_toolkit,
        )

        agent_counselor_gov_02 = ReActAgent(
            name="咨询单位（政府侧）02",
            sys_prompt=(
                f"目标：咨询单位（政府侧）02需根据项目需求和可研大纲的三章（第三章项目需求分析与产出方案）和已完成的初步可行性研究报告的二章（第二章项目建设背景和必要性），编写初步可行性研究报告的三章。编写完成后，将编写的内容存入{new_file_path}文件中report_index为{i}的对应键chapter03中。"
                f"控制约束内容：咨询单位（政府侧）02在编写初步可行性研究报告的三章时需严格根据项目需求和可研大纲的三章（第三章项目需求分析与产出方案）和已完成的初步可行性研究报告的二章（第二章项目建设背景和必要性）来编写，不可以瞎编或照抄可研大纲的内容。编写的内容需进行说明和公开通知，编写的内容需用markdown格式表示，分段使用段落分隔符“\n\n”。"
                f"支持使能内容：项目需求来自Host发布的共享信息。初步可行性研究报告的二章由咨询单位（政府侧）01完成。可研大纲的三章内容如下：三、项目需求分析与产出方案（一）需求分析在调查项目所涉产品或服务需求现状的基础上，分析产品或服务的可接受性或市场需求潜力，研究提出拟建项目功能定位、近期和远期目标、产品或服务的需求总量及结构。（二）建设内容和规模结合项目建设目标和功能定位等，论证拟建项目的总体布局、主要建设内容及规模，确定建设标准。大型、复杂及分期建设项目应根据项目整体规划、资源利用条件及近远期需求预测，明确项目近远期建设规模、分阶段建设目标和建设进度安排，并说明预留发展空间及其合理性、预留条件对远期规模的影响等。（三）项目产出方案研究提出拟建项目正常运营年份应达到的生产或服务能力及其质量标准要求，并评价项目建设内容、规模以及产出的合理性。"
            ),
            model_config_name="qwen_config",
            max_iters=15,
            verbose="True",
            service_toolkit=agent_counselor_service_toolkit,
        )

        agent_counselor_gov_03 = ReActAgent(
            name="咨询单位（政府侧）03",
            sys_prompt=(
                f"目标：咨询单位（政府侧）03需根据项目需求和可研大纲的四章（第四章项目选址与要素保障）和已完成的初步可行性研究报告的二、三章（第二章项目建设背景和必要性、第三章项目需求分析与产出方案），编写初步可行性研究报告的四章。编写完成后，将编写的内容存入{new_file_path}文件中report_index为{i}的对应键chapter04中。"
                f"控制约束内容：咨询单位（政府侧）03在编写初步可行性研究报告的四章时需严格根据项目需求和可研大纲的四章（第四章项目选址与要素保障）和已完成的初步可行性研究报告的二、三章（第二章项目建设背景和必要性、第三章项目需求分析与产出方案）来编写，不可以瞎编或照抄可研大纲的内容。编写的内容需进行说明和公开通知，编写的内容需用markdown格式表示，分段使用段落分隔符“\n\n”。"
                f"支持使能内容：项目需求来自Host发布的共享信息。初步可行性研究报告的二、三章分别由咨询单位（政府侧）01、咨询单位（政府侧）02完成。可研大纲的四章内容如下：四、项目选址与要素保障（一）项目选址或选线通过多方案比较，选择项目最佳或合理的场址或线路方案，明确拟建项目场址或线路的土地权属、供地方式、土地利用状况、矿产压覆、占用耕地和永久基本农田、涉及生态保护红线、地质灾害危险性评估等情况。备选场址方案或线路方案比选要综合考虑规划、技术、经济、社会等条件。（二）项目建设条件分析拟建项目所在区域的自然环境、交通运输、公用工程等建设条件。其中，自然环境条件包括地形地貌、气象、水文、泥沙、地质、地震、防洪等；交通运输条件包括铁路、公路、港口、机场、管道等；公用工程条件包括周边市政道路、水、电、气、热、消防和通信等。阐述施工条件、生活配套设施和公共服务依托条件等。改扩建工程要分析现有设施条件的容量和能力，提出设施改扩建和利用方案。（三）要素保障分析土地要素保障。分析拟建项目相关的国土空间规划、土地利用年度计划、建设用地控制指标等土地要素保障条件，开展节约集约用地论证分析，评价用地规模和功能分区的合理性、节地水平的先进性。说明拟建项目用地总体情况，包括地上（下）物情况等；涉及耕地、园地、林地、草地等农用地转为建设用地的，说明农用地转用指标的落实、转用审批手续办理安排及耕地占补平衡的落实情况；涉及占用永久基本农田的，说明永久基本农田占用补划情况；如果项目涉及用海用岛，应明确用海用岛的方式、具体位置和规模等内容。资源环境要素保障。分析拟建项目水资源、能源、大气环境、生态等承载能力及其保障条件，以及取水总量、能耗、碳排放强度和污染减排指标控制要求等，说明是否存在环境敏感区和环境制约因素。对于涉及用海的项目，应分析利用港口岸线资源、航道资源的基本情况及其保障条件；对于需围填海的项目，应分析围填海基本情况及其保障条件。对于重大投资项目，应列示规划、用地、用水、用能、环境以及可能涉及的用海、用岛等要素保障指标，并综合分析提出要素保障方案。"
            ),
            model_config_name="qwen_config",
            max_iters=15,
            verbose="True",
            service_toolkit=agent_counselor_service_toolkit,
        )

        agent_counselor_gov_04 = ReActAgent(
            name="咨询单位（政府侧）04",
            sys_prompt=(
                f"目标：咨询单位（政府侧）04需根据项目需求和可研大纲第八章（第八章项目影响效果分析）和已完成的初步可行性研究报告的二、三、四、五、六、七章（第二章项目建设背景和必要性、第三章项目需求分析与产出方案、第四章项目选址与要素保障、第五章项目建设方案、第六章项目运营方案、第七章项目投融资与财务方案），编写初步可行性研究报告的第八章内容。编写完成后，将编写的内容存入{new_file_path}文件中report_index为{i}的对应键chapter08中。"
                f"控制约束内容：咨询单位（政府侧）04在编写初步可行性研究报告的第八章内容时需严格根据项目需求和可研大纲第八章和已完成的初步可行性研究报告的二、三、四、五、六、七章（第二章项目建设背景和必要性、第三章项目需求分析与产出方案、第四章项目选址与要素保障、第五章项目建设方案、第六章项目运营方案、第七章项目投融资与财务方案）来编写，不可以瞎编或照抄可研大纲的内容。编写的内容需进行说明和公开通知，编写的内容需用markdown格式表示，分段使用段落分隔符“\n\n”。"
                f"支持使能内容：项目需求来自Host发布的共享信息。初步可行性研究报告的二、三、四章分别由咨询单位（政府侧）01、咨询单位（政府侧）02、咨询单位（政府侧）03完成。初步可行性研究报告的第六章项目运营方案由运营单位（政府侧）完成。初步可行性研究报告的第五章项目建设方案由建设单位（政府侧）完成。初步可行性研究报告的第七章项目投融资与财务方案由投融资单位（政府侧）完成。可研大纲的八章内容如下：八、项目影响效果分析（一）经济影响分析对于具有明显经济外部效应的政府投资项目，计算项目对经济资源的耗费和实际贡献，分析项目费用效益或效果，以及重大投资项目对宏观经济、产业经济、区域经济等所产生的影响，评价拟建项目的经济合理性。（二）社会影响分析通过社会调查和公众参与，识别项目主要社会影响因素和主要利益相关者，分析不同目标群体的诉求及其对项目的支持程度，评价项目采取以工代赈等方式在带动当地就业、促进技能提升等方面的预期成效，以及促进员工发展、社区发展和社会发展等方面的社会责任，提出减缓负面社会影响的措施或方案。（三）生态环境影响分析分析拟建项目所在地的环境和生态现状，评价项目在污染物排放、地质灾害防治、防洪减灾、水土流失、土地复垦、生态保护、生物多样性和环境敏感区等方面的影响，提出生态环境影响减缓、生态修复和补偿等措施，以及污染物减排措施，评价拟建项目能否满足有关生态环境保护政策要求。（四）资源和能源利用效果分析研究拟建项目的矿产资源、森林资源、水资源（含非常规水源）、能源、再生资源、废物和污水资源化利用，以及设备回收利用情况，通过单位生产能力主要资源消耗量等指标分析，提出资源节约、关键资源保障，以及供应链安全、节能等方面措施，计算采取资源节约和资源化利用措施后的资源消耗总量及强度。计算采取节能措施后的全口径能源消耗总量、原料用能消耗量、可再生能源消耗量等指标，评价项目能效水平以及对项目所在地区能耗调控的影响。（五）碳达峰碳中和分析对于高耗能、高排放项目，在项目能源资源利用分析的基础上，预测并核算项目年度碳排放总量、主要产品碳排放强度，提出项目碳排放控制方案，明确拟采取减少碳排放的路径与方式，分析项目对所在地区碳达峰碳中和目标实现的影响。"
            ),
            model_config_name="qwen_config",
            max_iters=15,
            verbose="True",
            service_toolkit=agent_counselor_service_toolkit,
        )

        agent_counselor_gov_05 = ReActAgent(
            name="咨询单位（政府侧）05",
            sys_prompt=(
                f"目标：咨询单位（政府侧）05需根据项目需求和可研大纲第九章（第九章项目风险管控方案）和已完成的初步可行性研究报告的二、三、四、五、六、七、八章（第二章项目建设背景和必要性、第三章项目需求分析与产出方案、第四章项目选址与要素保障、第五章项目建设方案、第六章项目运营方案、第七章项目投融资与财务方案、第八章项目影响效果分析），编写初步可行性研究报告的第九章内容。编写完成后，将编写的内容存入{new_file_path}文件中report_index为{i}的对应键chapter09中。"
                f"控制约束内容：咨询单位（政府侧）05在编写初步可行性研究报告的第九章内容时需严格根据项目需求和可研大纲第九章和已完成的初步可行性研究报告的二、三、四、五、六、七、八章（第二章项目建设背景和必要性、第三章项目需求分析与产出方案、第四章项目选址与要素保障、第五章项目建设方案、第六章项目运营方案、第七章项目投融资与财务方案、第八章项目影响效果分析）来编写，不可以瞎编或照抄可研大纲的内容。编写的内容需进行说明和公开通知，编写的内容需用markdown格式表示，分段使用段落分隔符“\n\n”。"
                f"支持使能内容：项目需求来自Host发布的共享信息。初步可行性研究报告的二、三、四章分别由咨询单位（政府侧）01、咨询单位（政府侧）02、咨询单位（政府侧）03完成。初步可行性研究报告的第六章项目运营方案由运营单位（政府侧）完成。初步可行性研究报告的第五章项目建设方案由建设单位（政府侧）完成。初步可行性研究报告的第七章项目投融资与财务方案由投融资单位（政府侧）完成。初步可行性研究报告的第八章项目影响效果分析由咨询单位（政府侧）04完成。可研大纲的九章内容如下：九、项目风险管控方案（一）风险识别与评价识别项目全生命周期的主要风险因素，包括需求、建设、运营、融资、财务、经济、社会、环境、网络与数据安全等方面，分析各风险发生的可能性、损失程度，以及风险承担主体的韧性或脆弱性，判断各风险后果的严重程度，研究确定项目面临的主要风险。（二）风险管控方案结合项目特点和风险评价，有针对性地提出项目主要风险的防范和化解措施。重大项目应当对社会稳定风险进行调查分析，查找并列出风险点、风险发生的可能性及影响程度，提出防范和化解风险的方案措施，提出采取相关措施后的社会稳定风险等级建议。对可能引发“邻避”问题的，应提出综合管控方案，保证影响社会稳定的风险在采取措施后处于低风险且可控状态。（三）风险应急预案对于拟建项目可能发生的风险，研究制定重大风险应急预案，明确应急处置及应急演练要求等。"
            ),
            model_config_name="qwen_config",
            max_iters=15,
            verbose="True",
            service_toolkit=agent_counselor_service_toolkit,
        )

        agent_counselor_gov_06 = ReActAgent(
            name="咨询单位（政府侧）06",
            sys_prompt=(
                f"目标：咨询单位（政府侧）06需根据项目需求和可研大纲第十章（第十章研究结论及建议）和已完成的初步可行性研究报告的二、三、四、五、六、七、八、九章（第二章项目建设背景和必要性、第三章项目需求分析与产出方案、第四章项目选址与要素保障、第五章项目建设方案、第六章项目运营方案、第七章项目投融资与财务方案、第八章项目影响效果分析、第九章项目风险管控方案），编写初步可行性研究报告的第十章内容。编写完成后，将编写的内容存入{new_file_path}文件中report_index为{i}的对应键chapter10中。"
                f"控制约束内容：咨询单位（政府侧）06在编写初步可行性研究报告的第十章内容时需严格根据项目需求和可研大纲第十章和已完成的初步可行性研究报告的二、三、四、五、六、七、八、九章（第二章项目建设背景和必要性、第三章项目需求分析与产出方案、第四章项目选址与要素保障、第五章项目建设方案、第六章项目运营方案、第七章项目投融资与财务方案、第八章项目影响效果分析、第九章项目风险管控方案）来编写，不可以瞎编或照抄可研大纲的内容。编写的内容需进行说明和公开通知，编写的内容需用markdown格式表示，分段使用段落分隔符“\n\n”。"
                f"支持使能内容：项目需求来自Host发布的共享信息。初步可行性研究报告的二、三、四章分别由咨询单位（政府侧）01、咨询单位（政府侧）02、咨询单位（政府侧）03完成。初步可行性研究报告的第六章项目运营方案由运营单位（政府侧）完成。初步可行性研究报告的第五章项目建设方案由建设单位（政府侧）完成。初步可行性研究报告的第七章项目投融资与财务方案由投融资单位（政府侧）完成。初步可行性研究报告的第八章项目影响效果分析由咨询单位（政府侧）04完成。初步可行性研究报告的第九章项目风险管控方案由咨询单位（政府侧）05完成。可研大纲的十章内容如下：十、研究结论及建议（一）主要研究结论从建设必要性、要素保障性、工程可行性、运营有效性、财务合理性、影响可持续性、风险可控性等维度分别简述项目可行性研究结论，评价项目在经济、社会、环境等各方面效果和风险，提出项目是否可行的研究结论。（二）问题与建议针对项目需要重点关注和进一步研究解决的问题，提出相关建议。"
            ),
            model_config_name="qwen_config",
            max_iters=15,
            verbose="True",
            service_toolkit=agent_counselor_service_toolkit,
        )

        agent_counselor_gov_07 = ReActAgent(
            name="咨询单位（政府侧）07",
            sys_prompt=(
                f"目标：咨询单位（政府侧）07需根据项目需求和可研大纲第一章（第一章概述）和已完成的初步可行性研究报告的二、三、四、五、六、七、八、九、十章（第二章项目建设背景和必要性、第三章项目需求分析与产出方案、第四章项目选址与要素保障、第五章项目建设方案、第六章项目运营方案、第七章项目投融资与财务方案、第八章项目影响效果分析、第九章项目风险管控方案、第十章研究结论及建议），编写初步可行性研究报告的第一章内容。编写完成后，将编写的内容存入{new_file_path}文件中report_index为{i}的对应键chapter01中。"
                f"控制约束内容：咨询单位（政府侧）07在编写初步可行性研究报告的第一章内容时需严格根据项目需求和可研大纲第一章和已完成的初步可行性研究报告的二、三、四、五、六、七、八、九、十章（第二章项目建设背景和必要性、第三章项目需求分析与产出方案、第四章项目选址与要素保障、第五章项目建设方案、第六章项目运营方案、第七章项目投融资与财务方案、第八章项目影响效果分析、第九章项目风险管控方案、第十章研究结论及建议）来编写，不可以瞎编或照抄可研大纲的内容。编写的内容需进行说明和公开通知，编写的内容需用markdown格式表示，分段使用段落分隔符“\n\n”。"
                f"支持使能内容：项目需求来自Host发布的共享信息。初步可行性研究报告的二、三、四章分别由咨询单位（政府侧）01、咨询单位（政府侧）02、咨询单位（政府侧）03完成。初步可行性研究报告的第六章项目运营方案由运营单位（政府侧）完成。初步可行性研究报告的第五章项目建设方案由建设单位（政府侧）完成。初步可行性研究报告的第七章项目投融资与财务方案由投融资单位（政府侧）完成。初步可行性研究报告的第八章项目影响效果分析由咨询单位（政府侧）04完成。初步可行性研究报告的第九章项目风险管控方案由咨询单位（政府侧）05完成。初步可行性研究报告的第十章研究结论及建议由咨询单位（政府侧）06完成。可研大纲的第一章内容如下：一、概述（一）项目概况项目全称及简称。概述项目建设目标和任务、建设地点、建设内容和规模（含主要产出）、建设工期、投资规模和资金来源、建设模式、主要技术经济指标、绩效目标等。（二）项目单位概况简述项目单位基本情况。拟新组建项目法人的，简述项目法人组建方案。对于政府资本金注入项目，简述项目法人基本信息、投资人（或者股东）构成及政府出资人代表等情况。（三）编制依据概述项目建议书（或项目建设规划）及其批复文件、国家和地方有关支持性规划、产业政策和行业准入条件、主要标准规范、专题研究成果，以及其他依据。（四）主要结论和建议简述项目可行性研究的主要结论和建议。"
            ),
            model_config_name="qwen_config",
            max_iters=15,
            verbose="True",
            service_toolkit=agent_counselor_service_toolkit,
        )


        agent_operator_gov = ReActAgent(
            name="运营单位（政府侧）",
            sys_prompt=(
                f"目标：运营单位（政府侧）根据项目需求和可研大纲第六章项目运营方案和已完成的初步可行性研究报告的二、三、四章（第二章项目建设背景和必要性、第三章项目需求分析与产出方案、第四章项目选址与要素保障），编写初步可行性研究报告的第六章项目运营方案。编写完成后，将编写的内容存入{new_file_path}文件中report_index为{i}的对应键chapter06中。"
                f"控制约束内容：运营单位（政府侧）在编写初步可行性研究报告的第六章项目运营方案时需严格根据项目需求和可研大纲第六章项目运营方案和已完成的初步可行性研究报告的二、三、四章（第二章项目建设背景和必要性、第三章项目需求分析与产出方案、第四章项目选址与要素保障）来编写，不可以瞎编或照抄可研大纲的内容。编写的内容需进行说明和公开通知，编写的内容需用markdown格式表示，分段使用段落分隔符“\n\n”。"
                f"支持使能内容：项目需求来自Host发布的共享信息。初步可行性研究报告的二、三、四章分别由咨询单位（政府侧）01、咨询单位（政府侧）02、咨询单位（政府侧）03完成。可研大纲的第六章项目运营方案内容如下：六、项目运营方案（一）运营模式选择研究提出项目运营模式，确定自主运营管理还是委托第三方运营管理，并说明主要理由。委托第三方运营管理的，应提出对第三方的运营管理能力要求。（二）运营组织方案研究项目组织机构设置方案、人力资源配置方案、员工培训需求及计划，提出项目在合规管理、治理体系优化和信息披露等方面的措施。（三）安全保障方案分析项目运营管理中存在的危险因素及其危害程度，明确安全生产责任制，建立安全管理体系，提出劳动安全与卫生防范措施，以及项目可能涉及的数据安全、网络安全、供应链安全的责任制度或措施方案，并制定项目安全应急管理预案。（四）绩效管理方案研究制定项目全生命周期关键绩效指标和绩效管理机制，提出项目主要投入产出效率、直接效果、外部影响和可持续性等管理方案。大型、复杂及分期建设项目，应按照子项目分别确定绩效目标和评价指标体系，并说明影响项目绩效目标实现的关键因素。"
            ),
            model_config_name="qwen_config",
            max_iters=15,
            verbose="True",
            service_toolkit=agent_counselor_service_toolkit,
        )

        agent_constructor_gov = ReActAgent(
            name="建设单位（政府侧）",
            sys_prompt=(
                f"目标：建设单位（政府侧）根据项目需求和可研大纲第五章项目建设方案和已完成的初步可行性研究报告的二、三、四、六章（第二章项目建设背景和必要性、第三章项目需求分析与产出方案、第四章项目选址与要素保障、第六章项目运营方案），编写初步可行性研究报告的第五章项目建设方案。编写完成后，将编写的内容存入{new_file_path}文件中report_index为{i}的对应键chapter05中。"
                f"控制约束内容：建设单位（政府侧）在编写初步可行性研究报告的第五章项目建设方案时需严格根据项目需求和可研大纲第五章项目建设方案和已完成的初步可行性研究报告的二、三、四、六章（第二章项目建设背景和必要性、第三章项目需求分析与产出方案、第四章项目选址与要素保障、第六章项目运营方案）来编写，不可以瞎编或照抄可研大纲的内容。编写的内容需进行说明和公开通知，编写的内容需用markdown格式表示，分段使用段落分隔符“\n\n”。"
                f"支持使能内容：项目需求来自Host发布的共享信息。初步可行性研究报告的二、三、四章分别由咨询单位（政府侧）01、咨询单位（政府侧）02、咨询单位（政府侧）03完成。初步可行性研究报告的第六章项目运营方案由运营单位（政府侧）完成。可研大纲的第五章项目建设方案内容如下：五、项目建设方案（一）技术方案通过技术比较提出项目预期达到的技术目标、技术来源及其实现路径，确定核心技术方案和核心技术指标。简述推荐技术路线的理由。对于专利或关键核心技术，需要分析其取得方式的可靠性、知识产权保护、技术标准和自主可控性等。（二）设备方案通过设备比选提出所需主要设备（含软件）的规格、数量、性能参数、来源和价格，论述设备（含软件）与技术的匹配性和可靠性、设备（含软件）对工程方案的设计技术需求，提出关键设备和软件推荐方案及自主知识产权情况。对于关键设备，进行单台技术经济论证，说明设备调研情况；对于非标设备，说明设备原理和组成。对于改扩建项目，分析现有设备利用或改造情况。涉及超限设备的，研究提出相应的运输方案，特殊设备提出安装要求。（三）工程方案通过方案比选提出工程建设标准、工程总体布置、主要建（构）筑物和系统设计方案、外部运输方案、公用工程方案及其他配套设施方案。工程方案要充分考虑土地利用、地上地下空间综合利用、人民防空工程、抗震设防、防洪减灾、消防应急等要求，以及绿色和韧性工程相关内容，并结合项目所属行业特点，细化工程方案有关内容和要求。涉及分期建设的项目，需要阐述分期建设方案；涉及重大技术问题的，还应阐述需要开展的专题论证工作。（四）用地用海征收补偿（安置）方案涉及土地征收或用海海域征收的项目，应根据有关法律法规政策规定，提出征收补偿（安置）方案。土地征收补偿（安置）方案应当包括征收范围、土地现状、征收目的、补偿方式和标准、安置对象、安置方式、社会保障、补偿（安置）费用等内容。用海用岛涉及利益相关者的，应根据有关法律法规政策规定等，确定利益相关者协调方案。（五）数字化方案对于具备条件的项目，研究提出拟建项目数字化应用方案，包括技术、设备、工程、建设管理和运维、网络与数据安全保障等方面，提出以数字化交付为目的，实现设计-施工-运维全过程数字化应用方案。（六）建设管理方案提出项目建设组织模式和机构设置，制定质量、安全管理方案和验收标准，明确建设质量和安全管理目标及要求，提出拟采用新材料、新设备、新技术、新工艺等推动高质量建设的技术措施。根据项目实际提出拟实施以工代赈的建设任务等。提出项目建设工期，对项目建设主要时间节点做出时序性安排。提出包括招标范围、招标组织形式和招标方式等在内的拟建项目招标方案。研究提出拟采用的建设管理模式，如代建管理、全过程工程咨询服务、工程总承包（EPC）等。"
            ),
            model_config_name="qwen_config",
            max_iters=15,
            verbose="True",
            service_toolkit=agent_counselor_service_toolkit,
        )

        agent_Investor_financier_gov = ReActAgent(
            name="投融资单位（政府侧）",
            sys_prompt=(
                f"目标：投融资单位（政府侧）根据项目需求和可研大纲第七章项目投融资与财务方案和已完成的初步可行性研究报告的二、三、四、五、六章（第二章项目建设背景和必要性、第三章项目需求分析与产出方案、第四章项目选址与要素保障、第五章项目建设方案、第六章项目运营方案），编写初步可行性研究报告的第七章项目投融资与财务方案。编写完成后，将编写的内容存入{new_file_path}文件中report_index为{i}的对应键chapter07中。"
                f"控制约束内容：投融资单位（政府侧）在编写初步可行性研究报告的第七章项目投融资与财务方案时需严格根据项目需求和可研大纲第七章项目投融资与财务方案和已完成的初步可行性研究报告的二、三、四、五、六章（第二章项目建设背景和必要性、第三章项目需求分析与产出方案、第四章项目选址与要素保障、第五章项目建设方案、第六章项目运营方案）来编写，不可以瞎编或照抄可研大纲的内容。编写的内容需进行说明和公开通知，编写的内容需用markdown格式表示，分段使用段落分隔符“\n\n”。"
                f"支持使能内容：项目需求来自Host发布的共享信息。初步可行性研究报告的二、三、四章分别由咨询单位（政府侧）01、咨询单位（政府侧）02、咨询单位（政府侧）03完成。初步可行性研究报告的第六章项目运营方案由运营单位（政府侧）完成。初步可行性研究报告的第五章项目建设方案由建设单位（政府侧）完成。可研大纲的第七章项目投融资与财务方案内容如下：七、项目投融资与财务方案（一）投资估算对项目建设和生产运营所需投入的全部资金即项目总投资进行估算，包括建设投资、建设期融资费用和流动资金，说明投资估算编制依据和编制范围，明确建设期内分年度投资计划。（二）盈利能力分析根据项目性质，确定适合的评价方法。结合项目运营期内的负荷要求，估算项目营业收入、补贴性收入及各种成本费用，并按相关行业要求提供量价协议、框架协议等支撑材料。通过项目自身的盈利能力分析，评价项目可融资性。对于政府直接投资的非经营性项目，开展项目全生命周期资金平衡分析，提出开源节流措施。对于政府资本金注入项目，计算财务内部收益率、财务净现值、投资回收期等指标，评价项目盈利能力；营业收入不足以覆盖项目成本费用的，提出政府支持方案。对于综合性开发项目，分析项目服务能力和潜在综合收益，评价项目采用市场化机制的可行性和利益相关方的可接受性。（三）融资方案研究提出项目拟采用的融资方案，包括权益性融资和债务性融资，分析融资结构和资金成本。说明项目申请财政资金投入的必要性和方式，明确资金来源，提出形成资金闭环的管理方案。对于政府资本金注入项目，说明项目资本金来源和结构、与金融机构对接情况，研究采用权益型金融工具、专项债、公司信用类债券等融资方式的可行性，主要包括融资金额、融资期限、融资成本等关键要素。对于具备资产盘活条件的基础设施项目，研究项目建成后采取基础设施领域不动产投资信托基金（REITs）等方式盘活存量资产、实现项目投资回收的可能路径。（四）债务清偿能力分析对于使用债务融资的项目，明确债务清偿测算依据和还本付息资金来源，分析利息备付率、偿债备付率等指标，评价项目债务清偿能力，以及是否增加当地政府财政支出负担、引发地方政府隐性债务风险等情况。（五）财务可持续性分析对于政府资本金注入项目，编制财务计划现金流量表，计算各年净现金流量和累计盈余资金，判断拟建项目是否有足够的净现金流量维持正常运营。对于在项目经营期出现经营净现金流量不足的项目，研究提出现金流接续方案，分析政府财政补贴所需资金，评价项目财务可持续性。"
            ),
            model_config_name="qwen_config",
            max_iters=15,
            verbose="True",
            service_toolkit=agent_counselor_service_toolkit,
        )


        # 企业侧代理
        agent_counselor_com_01 = ReActAgent(
            name="咨询单位（企业侧）01",
            sys_prompt=(
                f"目标：咨询单位（企业侧）01需根据项目需求和可研大纲的二章（第二章项目建设背景、需求分析及产出方案），编写初步可行性研究报告的二章。编写完成后，将编写的内容存入{new_file_path}文件中report_index为{i}的对应键chapter02中。"
                f"控制约束内容：咨询单位（企业侧）01在编写初步可行性研究报告的二章时需严格根据项目需求和可研大纲的二章（第二章项目建设背景、需求分析及产出方案）来编写，不可以瞎编或照抄可研大纲的内容。编写的内容需进行说明和公开通知，编写的内容需用markdown格式表示，分段使用段落分隔符“\n\n”。"
                f"支持使能内容：项目需求来自Host发布的共享信息。可研大纲的二章内容如下：二、项目建设背景、需求分析及产出方案（一）规划政策符合性简述项目建设背景和前期工作进展情况，论述拟建项目与经济社会发展规划、产业政策、行业和市场准入标准的符合性。（二）企业发展战略需求分析对于关系企业长远发展的重大项目，论述企业发展战略对拟建项目的需求程度和拟建项目对促进企业发展战略实现的重要性和紧迫性。（三）项目市场需求分析结合企业自身情况和行业发展前景，分析拟建项目所在行业的业态、目标市场环境和容量、产业链供应链、产品或服务价格，评价市场饱和程度、项目产品或服务的竞争力，预测产品或服务的市场拥有量，提出市场营销策略等建议。（四）项目建设内容、规模和产出方案阐述拟建项目总体目标及分阶段目标，提出拟建项目建设内容和规模，明确项目产品方案或服务方案及其质量要求，并评价项目建设内容、规模以及产品方案的合理性。（五）项目商业模式根据项目主要商业计划，分析拟建项目收入来源和结构，判断项目是否具有充分的商业可行性和金融机构等相关方的可接受性。结合项目所在地政府或相关单位可以提供的条件，提出商业模式及其创新需求，研究项目综合开发等模式创新路径及可行性。"
            ),
            model_config_name="qwen_config",
            max_iters=15,
            verbose="True",
            service_toolkit=agent_counselor_service_toolkit,
        )

        agent_counselor_com_02 = ReActAgent(
            name="咨询单位（企业侧）02",
            sys_prompt=(
                f"目标：咨询单位（企业侧）02需根据项目需求和可研大纲的三章（第三章项目选址与要素保障）和已完成的初步可行性研究报告的二章（第二章项目建设背景、需求分析及产出方案），编写初步可行性研究报告的三章。编写完成后，将编写的内容存入{new_file_path}文件中report_index为{i}的对应键chapter03中。"
                f"控制约束内容：咨询单位（企业侧）02在编写初步可行性研究报告的三章时需严格根据项目需求和可研大纲的三章（第三章项目选址与要素保障）和已完成的初步可行性研究报告的二章（第二章项目建设背景、需求分析及产出方案）来编写，不可以瞎编或照抄可研大纲的内容。编写的内容需进行说明和公开通知，编写的内容需用markdown格式表示，分段使用段落分隔符“\n\n”。"
                f"支持使能内容：项目需求来自Host发布的共享信息。初步可行性研究报告的二章由咨询单位（企业侧）01完成。可研大纲的三章内容如下：三、项目选址与要素保障（一）项目选址或选线通过多方案比较，选择项目最佳或合理的场址或线路方案，明确拟建项目场址或线路的土地权属、供地方式、土地利用状况、矿产压覆、占用耕地和永久基本农田、涉及生态保护红线、地质灾害危险性评估等情况。备选场址方案或线路方案比选要综合考虑规划、技术、经济、社会等条件。（二）项目建设条件分析拟建项目所在区域的自然环境、交通运输、公用工程等建设条件。其中，自然环境条件包括地形地貌、气象、水文、泥沙、地质、地震、防洪等；交通运输条件包括铁路、公路、港口、机场、管道等；公用工程条件包括周边市政道路、水、电、气、热、消防和通信等。阐述施工条件、生活配套设施和公共服务依托条件等。改扩建工程要分析现有设施条件的容量和能力，提出设施改扩建和利用方案。（三）要素保障分析土地要素保障。分析拟建项目相关的国土空间规划、土地利用年度计划、建设用地控制指标等土地要素保障条件，开展节约集约用地论证分析，评价用地规模和功能分区的合理性、节地水平的先进性。说明拟建项目用地总体情况，包括地上（下）物情况等；涉及耕地、园地、林地、草地等农用地转为建设用地的，说明农用地转用指标的落实、转用审批手续办理安排及耕地占补平衡的落实情况；涉及占用永久基本农田的，说明永久基本农田占用补划情况；如果项目涉及用海用岛，应明确用海用岛的方式、具体位置和规模等内容。资源环境要素保障。分析拟建项目水资源、能源、大气环境、生态等承载能力及其保障条件，以及取水总量、能耗、碳排放强度和污染减排指标控制要求等，说明是否存在环境敏感区和环境制约因素。对于涉及用海的项目，应分析利用港口岸线资源、航道资源的基本情况及其保障条件；对于需围填海的项目，应分析围填海基本情况及其保障条件。"
            ),
            model_config_name="qwen_config",
            max_iters=15,
            verbose="True",
            service_toolkit=agent_counselor_service_toolkit,
        )

        agent_counselor_com_03 = ReActAgent(
            name="咨询单位（企业侧）03",
            sys_prompt=(
                f"目标：咨询单位（企业侧）03需根据项目需求和可研大纲的七章（第七章项目影响效果分析）和已完成的初步可行性研究报告的二、三、四、五、六章（第二章项目建设背景、需求分析及产出方案、第三章项目选址与要素保障、第四章项目建设方案、第五章项目运营方案、第六章项目投融资与财务方案），编写初步可行性研究报告的七章。编写完成后，将编写的内容存入{new_file_path}文件中report_index为{i}的对应键chapter07中。"
                f"控制约束内容：咨询单位（企业侧）03在编写初步可行性研究报告的七章时需严格根据项目需求和可研大纲的七章（第七章项目影响效果分析）和已完成的初步可行性研究报告的二、三、四、五、六章（第二章项目建设背景、需求分析及产出方案、第三章项目选址与要素保障、第四章项目建设方案、第五章项目运营方案、第六章项目投融资与财务方案）来编写，不可以瞎编或照抄可研大纲的内容。编写的内容需进行说明和公开通知，编写的内容需用markdown格式表示，分段使用段落分隔符“\n\n”。"
                f"支持使能内容：项目需求来自Host发布的共享信息。初步可行性研究报告的二、三章分别由咨询单位（企业侧）01、咨询单位（企业侧）02完成。初步可行性研究报告的第五章项目运营方案由运营单位（企业侧）完成。初步可行性研究报告的第四章项目建设方案由建设单位（企业侧）完成。初步可行性研究报告的第六章项目投融资与财务方案由投融资单位（企业侧）完成。可研大纲的七章内容如下：七、项目影响效果分析（一）经济影响分析对于具有明显经济外部效应的企业投资项目，论证项目费用效益或效果，以及重大项目可能对宏观经济、产业经济、区域经济等产生的影响，评价拟建项目的经济合理性。（二）社会影响分析通过社会调查和公众参与，识别项目主要社会影响因素和关键利益相关者，分析不同目标群体的诉求及其对项目的支持程度，评价项目在带动当地就业、促进企业员工发展、社区发展和社会发展等方面的社会责任，提出减缓负面社会影响的措施或方案。（三）生态环境影响分析分析拟建项目所在地的生态环境现状，评价项目在污染物排放、地质灾害防治、防洪减灾、水土流失、土地复垦、生态保护、生物多样性和环境敏感区等方面的影响，提出生态环境影响减缓、生态修复和补偿等措施，以及污染物减排措施，评价拟建项目能否满足有关生态环境保护政策要求。（四）资源和能源利用效果分析对于占用重要资源的项目，分析项目所需消耗的资源品种、数量、来源情况，以及非常规水源和污水资源化利用情况，提出资源综合利用方案和资源节约措施，计算采取资源节约和资源化利用措施后的资源消耗总量及强度。计算采取节能措施后的全口径能源消耗总量、原料用能消耗量、可再生能源消耗量等指标，评价项目能效水平以及对项目所在地区能耗调控的影响。（五）碳达峰碳中和分析对于高耗能、高排放项目，在项目能源资源利用分析基础上，预测并核算项目年度碳排放总量、主要产品碳排放强度，提出项目碳排放控制方案，明确拟采取减少碳排放的路径与方式，分析项目对所在地区碳达峰碳中和目标实现的影响。"
            ),
            model_config_name="qwen_config",
            max_iters=15,
            verbose="True",
            service_toolkit=agent_counselor_service_toolkit,
        )

        agent_counselor_com_04 = ReActAgent(
            name="咨询单位（企业侧）04",
            sys_prompt=(
                f"目标：咨询单位（企业侧）04需根据项目需求和可研大纲第八章（第八章项目风险管控方案）和已完成的初步可行性研究报告的二、三、四、五、六、七章（第二章项目建设背景、需求分析及产出方案、第三章项目选址与要素保障、第四章项目建设方案、第五章项目运营方案、第六章项目投融资与财务方案、第七章项目影响效果分析），编写初步可行性研究报告的第八章内容。编写完成后，将编写的内容存入{new_file_path}文件中report_index为{i}的对应键chapter08中。"
                f"控制约束内容：咨询单位（企业侧）04在编写初步可行性研究报告的第八章内容时需严格根据项目需求和可研大纲第八章和已完成的初步可行性研究报告的二、三、四、五、六、七章（第二章项目建设背景、需求分析及产出方案、第三章项目选址与要素保障、第四章项目建设方案、第五章项目运营方案、第六章项目投融资与财务方案、第七章项目影响效果分析）来编写，不可以瞎编或照抄可研大纲的内容。编写的内容需进行说明和公开通知，编写的内容需用markdown格式表示，分段使用段落分隔符“\n\n”。"
                f"支持使能内容：项目需求来自Host发布的共享信息。初步可行性研究报告的二、三、七章分别由咨询单位（企业侧）01、咨询单位（企业侧）02、咨询单位（企业侧）03完成。初步可行性研究报告的第五章项目运营方案由运营单位（企业侧）完成。初步可行性研究报告的第四章项目建设方案由建设单位（企业侧）完成。初步可行性研究报告的第六章项目投融资与财务方案由投融资单位（企业侧）完成。可研大纲的八章内容如下：八、项目风险管控方案（一）风险识别与评价识别项目市场需求、产业链供应链、关键技术、工程建设、运营管理、投融资、财务效益、生态环境、社会影响、网络与数据安全等方面的风险，分析各风险发生的可能性、损失程度，以及风险承担主体的韧性或脆弱性，判断各风险后果的严重程度，研究确定项目面临的主要风险。（二）风险管控方案结合项目特点和风险评价，有针对性地提出项目主要风险的防范和化解措施。重大项目应当对社会稳定风险进行调查分析，查找并列出风险点、风险发生的可能性及影响程度，提出防范和化解风险的方案措施，提出采取相关措施后的社会稳定风险等级建议。对可能引发“邻避”问题的，应提出综合管控方案，保证影响社会稳定的风险在采取措施后处于低风险且可控状态。（三）风险应急预案对于拟建项目可能发生的风险，研究制定重大风险应急预案，明确应急处置及应急演练要求等。"
            ),
            model_config_name="qwen_config",
            max_iters=15,
            verbose="True",
            service_toolkit=agent_counselor_service_toolkit,
        )

        agent_counselor_com_05 = ReActAgent(
            name="咨询单位（企业侧）05",
            sys_prompt=(
                f"目标：咨询单位（企业侧）05需根据项目需求和可研大纲第九章（第九章研究结论及建议）和已完成的初步可行性研究报告的二、三、四、五、六、七、八章（第二章项目建设背景、需求分析及产出方案、第三章项目选址与要素保障、第四章项目建设方案、第五章项目运营方案、第六章项目投融资与财务方案、第七章项目影响效果分析、第八章项目风险管控方案），编写初步可行性研究报告的第九章内容。编写完成后，将编写的内容存入{new_file_path}文件中report_index为{i}的对应键chapter09中。"
                f"控制约束内容：咨询单位（企业侧）05在编写初步可行性研究报告的第九章内容时需严格根据项目需求和可研大纲第九章和已完成的初步可行性研究报告的二、三、四、五、六、七、八章（第二章项目建设背景、需求分析及产出方案、第三章项目选址与要素保障、第四章项目建设方案、第五章项目运营方案、第六章项目投融资与财务方案、第七章项目影响效果分析、第八章项目风险管控方案）来编写，不可以瞎编或照抄可研大纲的内容。编写的内容需进行说明和公开通知，编写的内容需用markdown格式表示，分段使用段落分隔符“\n\n”。"
                f"支持使能内容：项目需求来自Host发布的共享信息。初步可行性研究报告的二、三、七、八章分别由咨询单位（企业侧）01、咨询单位（企业侧）02、咨询单位（企业侧）03、咨询单位（企业侧）04完成。初步可行性研究报告的第五章项目运营方案由运营单位（企业侧）完成。初步可行性研究报告的第四章项目建设方案由建设单位（企业侧）完成。初步可行性研究报告的第六章项目投融资与财务方案由投融资单位（企业侧）完成。可研大纲的九章内容如下：九、研究结论及建议（一）主要研究结论从建设必要性、要素保障性、工程可行性、运营有效性、财务合理性、影响可持续性、风险可控性等维度分别简述项目可行性研究结论，重点归纳总结拟推荐方案的项目市场需求、建设内容和规模、运营方案、投融资和财务效益，并评价项目各方面的效果和风险，提出项目是否可行的研究结论。（二）问题与建议针对项目需要重点关注和进一步研究解决的问题，提出相关建议。"
            ),
            model_config_name="qwen_config",
            max_iters=15,
            verbose="True",
            service_toolkit=agent_counselor_service_toolkit,
        )

        agent_counselor_com_06 = ReActAgent(
            name="咨询单位（企业侧）06",
            sys_prompt=(
                f"目标：咨询单位（企业侧）06需根据项目需求和可研大纲第一章（第一章概述）和已完成的初步可行性研究报告的二、三、四、五、六、七、八、九章（第二章项目建设背景、需求分析及产出方案、第三章项目选址与要素保障、第四章项目建设方案、第五章项目运营方案、第六章项目投融资与财务方案、第七章项目影响效果分析、第八章项目风险管控方案、第九章研究结论及建议），编写初步可行性研究报告的第一章内容。编写完成后，将编写的内容存入{new_file_path}文件中report_index为{i}的对应键chapter01中。"
                f"控制约束内容：咨询单位（企业侧）06在编写初步可行性研究报告的第一章内容时需严格根据项目需求和可研大纲第一章和已完成的初步可行性研究报告的二、三、四、五、六、七、八、九章（第二章项目建设背景、需求分析及产出方案、第三章项目选址与要素保障、第四章项目建设方案、第五章项目运营方案、第六章项目投融资与财务方案、第七章项目影响效果分析、第八章项目风险管控方案、第九章研究结论及建议）来编写，不可以瞎编或照抄可研大纲的内容。编写的内容需进行说明和公开通知，编写的内容需用markdown格式表示，分段使用段落分隔符“\n\n”。"
                f"支持使能内容：项目需求来自Host发布的共享信息。初步可行性研究报告的二、三、七、八、九章分别由咨询单位（企业侧）01、咨询单位（企业侧）02、咨询单位（企业侧）03、咨询单位（企业侧）04、咨询单位（企业侧）05完成。初步可行性研究报告的第五章项目运营方案由运营单位（企业侧）完成。初步可行性研究报告的第四章项目建设方案由建设单位（企业侧）完成。初步可行性研究报告的第六章项目投融资与财务方案由投融资单位（企业侧）完成。可研大纲的一章内容如下：一、概述（一）项目概况项目全称及简称。概述项目建设目标和任务、建设地点、建设内容和规模（含主要产出）、建设工期、投资规模和资金来源、建设模式、主要技术经济指标等。（二）企业概况简述企业基本信息、发展现状、财务状况、类似项目情况、企业信用和总体能力，有关政府批复和金融机构支持等情况。分析企业综合能力与拟建项目的匹配性。属于国有控股企业的，应说明其上级控股单位的主责主业，以及拟建项目与其主责主业的符合性。（三）编制依据概述国家和地方有关支持性规划、产业政策和行业准入条件、企业战略、标准规范、专题研究成果，以及其他依据。（四）主要结论和建议简述项目可行性研究的主要结论和建议。"
            ),
            model_config_name="qwen_config",
            max_iters=15,
            verbose="True",
            service_toolkit=agent_counselor_service_toolkit,
        )

        agent_operator_com = ReActAgent(
            name="运营单位（企业侧）",
            sys_prompt=(
                f"目标：运营单位（企业侧）根据项目需求和可研大纲第五章项目运营方案和已完成的初步可行性研究报告的二、三章（第二章项目建设背景、需求分析及产出方案、第三章项目选址与要素保障），编写初步可行性研究报告的第五章项目运营方案。编写完成后，将编写的内容存入{new_file_path}文件中report_index为{i}的对应键chapter05中。"
                f"控制约束内容：运营单位（企业侧）在编写初步可行性研究报告的第五章项目运营方案时需严格根据项目需求和可研大纲第五章项目运营方案和已完成的初步可行性研究报告的二、三章（第二章项目建设背景、需求分析及产出方案、第三章项目选址与要素保障）来编写，不可以瞎编或照抄可研大纲的内容。编写的内容需进行说明和公开通知，编写的内容需用markdown格式表示，分段使用段落分隔符“\n\n”。"
                f"支持使能内容：项目需求来自Host发布的共享信息。初步可行性研究报告的二、三章分别由咨询单位（企业侧）01、咨询单位（企业侧）02完成。可研大纲的第五章项目运营方案内容如下：五、项目运营方案（一）生产经营方案对于产品生产类企业投资项目，提出拟建项目的产品质量安全保障方案、原材料供应保障方案、燃料动力供应保障方案以及维护维修方案，评价生产经营的有效性和可持续性。对于运营服务类企业投资项目，明确拟建项目运营服务内容、标准、流程、计量、运营维护与修理，以及运营服务效率要求等，研究提出运营服务方案。（二）安全保障方案分析项目运营管理中存在的危险因素及其危害程度，明确安全生产责任制，设置安全管理机构，建立安全管理体系，提出安全防范措施，制定项目安全应急管理预案。（三）运营管理方案简述拟建项目的运营机构设置方案，明确项目运营模式和治理结构要求，简述项目绩效考核方案、奖惩机制等。"
            ),
            model_config_name="qwen_config",
            max_iters=15,
            verbose="True",
            service_toolkit=agent_counselor_service_toolkit,
        )

        agent_constructor_com = ReActAgent(
            name="建设单位（企业侧）",
            sys_prompt=(
                f"目标：建设单位（企业侧）根据项目需求和可研大纲第四章项目建设方案和已完成的初步可行性研究报告的二、三、五章（第二章项目建设背景、需求分析及产出方案、第三章项目选址与要素保障、第五章项目运营方案），编写初步可行性研究报告的第四章项目建设方案。编写完成后，将编写的内容存入{new_file_path}文件中report_index为{i}的对应键chapter04中。"
                f"控制约束内容：建设单位（企业侧）在编写初步可行性研究报告的第四章项目建设方案时需严格根据项目需求和可研大纲第四章项目建设方案和已完成的初步可行性研究报告的二、三、五章（第二章项目建设背景、需求分析及产出方案、第三章项目选址与要素保障、第五章项目运营方案）来编写，不可以瞎编或照抄可研大纲的内容。编写的内容需进行说明和公开通知，编写的内容需用markdown格式表示，分段使用段落分隔符“\n\n”。"
                f"支持使能内容：项目需求来自Host发布的共享信息。初步可行性研究报告的二、三章分别由咨询单位（企业侧）01、咨询单位（企业侧）02完成。初步可行性研究报告的第五章项目运营方案由运营单位（企业侧）完成。可研大纲的第四章项目建设方案内容如下：四、项目建设方案（一）技术方案通过技术比较提出项目生产方法、生产工艺技术和流程、配套工程（辅助生产和公用工程等）、技术来源及其实现路径，论证项目技术的适用性、成熟性、可靠性和先进性。对于专利或关键核心技术，需要分析其获取方式、知识产权保护、技术标准和自主可控性等。简述推荐技术路线的理由，提出相应的技术指标。（二）设备方案通过设备比选提出拟建项目主要设备（含软件）的规格、数量和性能参数等内容，论述设备（含软件）与技术的匹配性和可靠性、设备和软件对工程方案的设计技术需求，提出关键设备和软件推荐方案及自主知识产权情况。必要时，对关键设备进行单台技术经济论证。利用和改造原有设备的，提出改造方案及其效果。涉及超限设备的，研究提出相应的运输方案，特殊设备提出安装要求。（三）工程方案通过方案比选提出工程建设标准、工程总体布置、主要建（构）筑物和系统设计方案、外部运输方案、公用工程方案及其他配套设施方案，明确工程安全质量和安全保障措施，对重大问题制定应对方案。涉及分期建设的项目，需要阐述分期建设方案；涉及重大技术问题的，还应阐述需要开展的专题论证工作。（四）资源开发方案对于资源开发类项目，应依据资源开发规划、资源储量、资源品质、赋存条件、开发价值等，研究制定资源开发和综合利用方案，评价资源利用效率。（五）用地用海征收补偿（安置）方案涉及土地征收或用海海域征收的项目，应根据有关法律法规政策规定，确定征收补偿（安置）方案，包括征收范围、土地现状、征收目的、补偿方式和标准、安置对象、安置方式、社会保障等内容。用海用岛涉及利益相关者的，应根据有关法律法规政策规定等，确定利益相关者协调方案。（六）数字化方案对于具备条件的项目，研究提出拟建项目数字化应用方案，包括技术、设备、工程、建设管理和运维、网络与数据安全保障等方面，提出以数字化交付为目的，实现设计-施工-运维全过程数字化应用方案。（七）建设管理方案提出项目建设组织模式、控制性工期和分期实施方案，确定项目建设是否满足投资管理合规性和施工安全管理要求。如果涉及招标，明确招标范围、招标组织形式和招标方式等。"
            ),
            model_config_name="qwen_config",
            max_iters=15,
            verbose="True",
            service_toolkit=agent_counselor_service_toolkit,
        )

        agent_Investor_financier_com = ReActAgent(
            name="投融资单位（企业侧）",
            sys_prompt=(
                f"目标：投融资单位（企业侧）根据项目需求和可研大纲第六章项目投融资与财务方案和已完成的初步可行性研究报告的二、三、四、五章（第二章项目建设背景、需求分析及产出方案、第三章项目选址与要素保障、第四章项目建设方案、第五章项目运营方案），编写初步可行性研究报告的第六章项目投融资与财务方案。编写完成后，将编写的内容存入{new_file_path}文件中report_index为{i}的对应键chapter06中。"
                f"控制约束内容：投融资单位（企业侧）在编写初步可行性研究报告的第六章项目投融资与财务方案时需严格根据项目需求和可研大纲第六章项目投融资与财务方案和已完成的初步可行性研究报告的二、三、四、五章（第二章项目建设背景、需求分析及产出方案、第三章项目选址与要素保障、第四章项目建设方案、第五章项目运营方案）来编写，不可以瞎编或照抄可研大纲的内容。编写的内容需进行说明和公开通知，编写的内容需用markdown格式表示，分段使用段落分隔符“\n\n”。"
                f"支持使能内容：项目需求来自Host发布的共享信息。初步可行性研究报告的二、三章分别由咨询单位（企业侧）01、咨询单位（企业侧）02完成。初步可行性研究报告的第五章项目运营方案由运营单位（企业侧）完成。初步可行性研究报告的第四章项目建设方案由建设单位（企业侧）完成。可研大纲的第六章项目投融资与财务方案内容如下：六、项目投融资与财务方案（一）投资估算说明投资估算编制范围、编制依据，估算项目建设投资、流动资金、建设期融资费用，明确建设期内分年度资金使用计划。（二）盈利能力分析根据项目性质，选择适合的评价方法，估算项目营业收入和补贴性收入及各种成本费用，并按相关行业要求提供量价协议、框架协议等支撑材料，分析项目的现金流入和流出情况，构建项目利润表和现金流量表，计算财务内部收益率、财务净现值等指标，评价项目的财务盈利能力，并开展盈亏平衡分析和敏感性分析，根据需要分析拟建项目对企业整体财务状况的影响。（三）融资方案结合企业自身及其股东出资能力，分析项目资本金和债务资金来源及结构、融资成本以及资金到位情况，评价项目的可融资性。结合企业和项目经济、社会、环境等评价结果，研究项目获得绿色金融、绿色债券支持的可能性。对于具备条件的基础设施项目，研究提出项目建成后通过基础设施领域不动产投资信托基金（REITs）等模式盘活存量资产、实现投资回收的可能性。企业拟申请政府投资补助或贴息的，应根据相关要求研究提出拟申报投资补助或贴息的资金额度及可行性。（四）债务清偿能力分析按照负债融资的期限、金额、还本付息方式等条件，分析计算偿债备付率、利息备付率等债务清偿能力评价指标，判断项目偿还债务本金及支付利息的能力。必要时，开展项目资产负债分析，计算资产负债率等指标，评价项目资金结构的合理性。（五）财务可持续性分析根据投资项目财务计划现金流量表，统筹考虑企业整体财务状况、总体信用及综合融资能力等因素，分析投资项目对企业的整体财务状况影响，包括对企业的现金流、利润、营业收入、资产、负债等主要指标的影响，判断拟建项目是否有足够的净现金流量，确保维持正常运营及保障资金链安全。"
            ),
            model_config_name="qwen_config",
            max_iters=15,
            verbose="True",
            service_toolkit=agent_counselor_service_toolkit,
        )



        # 创建流水线
        pipeline_4 = SequentialPipeline(
            [agent_counselor_gov_01, agent_counselor_gov_02, agent_counselor_gov_03, agent_operator_gov, agent_constructor_gov, agent_Investor_financier_gov, agent_counselor_gov_04, agent_counselor_gov_05, agent_counselor_gov_06, agent_counselor_gov_07]
        )

        pipeline_5 = SequentialPipeline(
            [agent_counselor_com_01, agent_counselor_com_02, agent_operator_com, agent_constructor_com, agent_Investor_financier_com, agent_counselor_com_03,  agent_counselor_com_04, agent_counselor_com_05, agent_counselor_com_06]
        )

        if domain_of_owner == "政府侧":
            with msghub(
                [agent_counselor_gov_01, agent_counselor_gov_02, agent_counselor_gov_03, agent_operator_gov, agent_constructor_gov, agent_Investor_financier_gov, agent_counselor_gov_04, agent_counselor_gov_05, agent_counselor_gov_06, agent_counselor_gov_07],
                announcement=Msg(
                    name="Host",
                    content=prompt,
                    role="system",
                ),
            ):
                flow_15 = pipeline_4(None)  # 传递None作为占位符，实际逻辑在流水线中处理

            # 清除政府侧代理的记忆
            agents = [agent_counselor_gov_01, agent_counselor_gov_02, agent_counselor_gov_03, agent_operator_gov, agent_constructor_gov, agent_Investor_financier_gov, agent_counselor_gov_04, agent_counselor_gov_05, agent_counselor_gov_06, agent_counselor_gov_07]
            for agent in agents:
                agent.memory.clear()

        elif domain_of_owner == "企业侧":
            with msghub(
                [agent_counselor_com_01, agent_counselor_com_02, agent_operator_com, agent_constructor_com, agent_Investor_financier_com, agent_counselor_com_03,  agent_counselor_com_04, agent_counselor_com_05, agent_counselor_com_06],
                announcement=Msg(
                    name="Host",
                    content=prompt,
                    role="system",
                ),
            ):
                flow_16 = pipeline_5(None)  # 传递None作为占位符，实际逻辑在流水线中处理

            # 清除企业侧代理的记忆
            agents = [agent_counselor_com_01, agent_counselor_com_02, agent_operator_com, agent_constructor_com, agent_Investor_financier_com, agent_counselor_com_03,  agent_counselor_com_04, agent_counselor_com_05, agent_counselor_com_06]
            for agent in agents:
                agent.memory.clear()

if __name__ == "__main__":
    main()